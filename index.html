<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Financial Analyst - GitHub Pages</title>
    
    <!-- PyScript -->
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #4f46e5;
            --primary-hover: #4338ca;
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --bot-bubble-bg: #f3f4f6;
            --user-bubble-bg: #4f46e5;
            --user-text-color: #ffffff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Main Chat Container */
        .chat-container {
            width: 100%;
            max-width: 900px;
            height: 90vh;
            background-color: var(--card-bg);
            border-radius: 24px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* Header */
        .chat-header {
            padding: 20px 30px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            z-index: 10;
        }

        .header-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .bot-avatar-large {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #4f46e5, #818cf8);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.2);
        }

        .header-text h1 {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .header-text p {
            font-size: 0.875rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background-color: #fbbf24; /* Yellow for loading */
            border-radius: 50%;
            transition: background-color 0.3s;
        }
        
        .status-dot.ready {
            background-color: #10b981; /* Green for ready */
        }

        /* Chat Area */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
            scroll-behavior: smooth;
        }

        .message-wrapper {
            display: flex;
            margin-bottom: 24px;
            opacity: 0;
            animation: fadeIn 0.3s ease forwards;
        }

        @keyframes fadeIn {
            to { opacity: 1; transform: translateY(0); }
        }

        .message-wrapper.bot {
            justify-content: flex-start;
        }

        .message-wrapper.user {
            justify-content: flex-end;
        }

        .bot-avatar-small {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #4f46e5, #818cf8);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .message-content {
            max-width: 70%;
            padding: 16px 20px;
            border-radius: 18px;
            font-size: 0.95rem;
            line-height: 1.6;
            position: relative;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        .message-wrapper.bot .message-content {
            background-color: var(--bot-bubble-bg);
            color: var(--text-primary);
            border-top-left-radius: 4px;
        }

        .message-wrapper.user .message-content {
            background-color: var(--user-bubble-bg);
            color: var(--user-text-color);
            border-top-right-radius: 4px;
            box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.2);
        }

        .message-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 6px;
            margin-left: 5px;
        }

        .message-wrapper.user .message-time {
            text-align: right;
            margin-right: 5px;
        }

        /* Suggestions */
        .suggestions-container {
            padding: 10px 30px 20px;
            display: flex;
            gap: 10px;
            overflow-x: auto;
            scrollbar-width: none; /* Firefox */
        }
        
        .suggestions-container::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }

        .suggestion-chip {
            padding: 8px 16px;
            background-color: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 20px;
            color: var(--text-primary);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .suggestion-chip:hover {
            background-color: #e0e7ff;
            color: var(--primary-color);
            border-color: #c7d2fe;
            transform: translateY(-1px);
        }

        /* Input Area */
        .input-area {
            padding: 20px 30px 30px;
            background-color: white;
            border-top: 1px solid #f3f4f6;
        }

        .input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        #user-input {
            width: 100%;
            padding: 16px 60px 16px 24px;
            background-color: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 16px;
            font-size: 1rem;
            font-family: inherit;
            outline: none;
            transition: all 0.2s;
        }

        #user-input:focus {
            border-color: var(--primary-color);
            background-color: white;
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
        }

        .send-btn {
            position: absolute;
            right: 12px;
            width: 44px;
            height: 44px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .send-btn:hover {
            background-color: var(--primary-hover);
            transform: scale(1.05);
        }
        
        .send-btn:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        /* Loading Overlay for PyScript */
        #pyscript_loading {
            position: absolute;
            top: 60px;
            left: 0;
            right: 0;
            background: rgba(255,255,255,0.8);
            padding: 10px;
            text-align: center;
            font-size: 0.8rem;
            color: var(--primary-color);
            z-index: 100;
            display: none; /* Managed by PyScript logic */
        }
        
        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .dot {
            width: 8px;
            height: 8px;
            background-color: #9ca3af;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        
        /* PyScript specific styles */
        div#pyscript_output { display: none; }
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- Header -->
        <div class="chat-header">
            <div class="header-info">
                <div class="bot-avatar-large">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="header-text">
                    <h1>FinBot Analyst</h1>
                    <p><span class="status-dot" id="status-dot"></span> <span id="status-text">Loading AI Engine...</span></p>
                </div>
            </div>
        </div>
        
        <div id="pyscript_loading">Initializing Python Environment...</div>

        <!-- Chat Messages -->
        <div class="chat-messages" id="chat-messages">
            <!-- Parameters: Content, Time, IsUser -->
            <div class="message-wrapper bot">
                <div class="bot-avatar-small">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="message-content">
                    <p>Hello! I'm your AI Financial Analyst. I can help you analyze your <strong>Holdings</strong> and <strong>Trades</strong> data.</p>
                    <p>Please wait a moment while I load the data engine...</p>
                </div>
            </div>
        </div>

        <!-- Suggestions -->
        <div class="suggestions-container">
            <button class="suggestion-chip" onclick="askQuestion('Total number of holdings')">ðŸ“Š Total Holdings</button>
            <button class="suggestion-chip" onclick="askQuestion('Which funds performed better?')">ðŸ“ˆ Best Funds</button>
            <button class="suggestion-chip" onclick="askQuestion('YTD P&L for Ytum')">ðŸ’° YTD P&L</button>
            <button class="suggestion-chip" onclick="askQuestion('How many buy trades?')">ðŸ›’ Buy Trades</button>
            <button class="suggestion-chip" onclick="askQuestion('List all funds')">ðŸ“‹ List Funds</button>
        </div>

        <!-- Input Area -->
        <div class="input-area">
            <div class="input-wrapper">
                <input type="text" id="user-input" placeholder="Loading engine..." disabled autocomplete="off">
                <button class="send-btn" id="send-btn" onclick="triggerPython()" disabled>
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Configure PyScript -->
    <!-- Use inline config to specify packages and files to fetch -->
    <py-config>
        packages = ["pandas"]
        
        [[fetch]]
        from = "."
        files = ["holdings.csv", "trades.csv"]
    </py-config>

    <!-- Python Logic -->
    <py-script>
        import pandas as pd
        import re
        from datetime import datetime
        from js import document, window, console
        import asyncio

        # -- Start of DataChatbot Class (Adapted for Browser) --
        class DataChatbot:
            def __init__(self):
                self.holdings_df = None
                self.trades_df = None
                self.load_data()
            
            def load_data(self):
                """Load the CSV files into DataFrames"""
                try:
                    # In PyScript, files defined in [[fetch]] are available in the virtual filesystem
                    self.holdings_df = pd.read_csv('holdings.csv')
                    self.trades_df = pd.read_csv('trades.csv')
                    
                    # Clean column names (strip whitespace)
                    self.holdings_df.columns = self.holdings_df.columns.str.strip()
                    self.trades_df.columns = self.trades_df.columns.str.strip()
                    
                    # Convert numeric columns where needed
                    numeric_cols_holdings = ['Qty', 'StartQty', 'Price', 'StartPrice', 
                                            'MV_Local', 'MV_Base', 'PL_DTD', 'PL_QTD', 'PL_MTD', 'PL_YTD']
                    for col in numeric_cols_holdings:
                        if col in self.holdings_df.columns:
                            self.holdings_df[col] = pd.to_numeric(self.holdings_df[col], errors='coerce')
                    
                    numeric_cols_trades = ['Quantity', 'Price', 'Principal', 'Interest', 
                                          'TotalCash', 'AllocationQTY', 'AllocationPrincipal']
                    for col in numeric_cols_trades:
                        if col in self.trades_df.columns:
                            self.trades_df[col] = pd.to_numeric(self.trades_df[col], errors='coerce')
                            
                    console.log("Data loaded successfully in browser!")
                    
                except Exception as e:
                    console.error(f"Error loading data: {e}")
            
            def get_all_funds(self):
                """Get list of all unique funds/portfolios"""
                holdings_funds = set(self.holdings_df['ShortName'].dropna().unique())
                holdings_portfolios = set(self.holdings_df['PortfolioName'].dropna().unique())
                trades_portfolios = set(self.trades_df['PortfolioName'].dropna().unique())
                return holdings_funds | holdings_portfolios | trades_portfolios
            
            def get_total_holdings_for_fund(self, fund_name):
                """Get total number of holdings for a specific fund"""
                mask = (self.holdings_df['ShortName'].str.lower().str.contains(fund_name.lower(), na=False) |
                        self.holdings_df['PortfolioName'].str.lower().str.contains(fund_name.lower(), na=False))
                count = mask.sum()
                return count if count > 0 else None
            
            def get_total_trades_for_fund(self, fund_name):
                """Get total number of trades for a specific fund"""
                mask = self.trades_df['PortfolioName'].str.lower().str.contains(fund_name.lower(), na=False)
                count = mask.sum()
                return count if count > 0 else None
            
            def get_total_holdings(self):
                return len(self.holdings_df)
            
            def get_total_trades(self):
                return len(self.trades_df)
            
            def get_fund_pnl_ytd(self, fund_name=None):
                """Get YTD P&L for a fund or all funds"""
                if fund_name:
                    mask = (self.holdings_df['ShortName'].str.lower().str.contains(fund_name.lower(), na=False) |
                            self.holdings_df['PortfolioName'].str.lower().str.contains(fund_name.lower(), na=False))
                    filtered = self.holdings_df[mask]
                    if len(filtered) > 0:
                        return filtered['PL_YTD'].sum()
                    return None
                else:
                    return self.holdings_df.groupby('ShortName')['PL_YTD'].sum().to_dict()
            
            def get_best_performing_funds(self, n=5):
                """Get best performing funds by YTD P&L"""
                fund_pnl = self.holdings_df.groupby('ShortName')['PL_YTD'].sum().sort_values(ascending=False)
                return fund_pnl.head(n)
            
            def get_worst_performing_funds(self, n=5):
                """Get worst performing funds by YTD P&L"""
                fund_pnl = self.holdings_df.groupby('ShortName')['PL_YTD'].sum().sort_values(ascending=True)
                return fund_pnl.head(n)
            
            def get_fund_performance_ranking(self):
                """Get all funds ranked by YTD P&L"""
                fund_pnl = self.holdings_df.groupby('ShortName')['PL_YTD'].sum().sort_values(ascending=False)
                return fund_pnl
            
            def get_securities_for_fund(self, fund_name):
                """Get list of securities held by a fund"""
                mask = (self.holdings_df['ShortName'].str.lower().str.contains(fund_name.lower(), na=False) |
                        self.holdings_df['PortfolioName'].str.lower().str.contains(fund_name.lower(), na=False))
                filtered = self.holdings_df[mask]
                if len(filtered) > 0:
                    return filtered['SecName'].unique().tolist()
                return None
            
            def get_security_types_for_fund(self, fund_name):
                """Get security types held by a fund"""
                mask = (self.holdings_df['ShortName'].str.lower().str.contains(fund_name.lower(), na=False) |
                        self.holdings_df['PortfolioName'].str.lower().str.contains(fund_name.lower(), na=False))
                filtered = self.holdings_df[mask]
                if len(filtered) > 0:
                    return filtered['SecurityTypeName'].unique().tolist()
                return None
            
            def get_trade_types_summary(self):
                """Get summary of trade types (Buy/Sell)"""
                return self.trades_df['TradeTypeName'].value_counts().to_dict()
            
            def get_trades_by_type(self, trade_type):
                """Get trades filtered by type (Buy/Sell)"""
                mask = self.trades_df['TradeTypeName'].str.lower() == trade_type.lower()
                return mask.sum()
            
            def get_fund_market_value(self, fund_name):
                """Get total market value for a fund"""
                mask = (self.holdings_df['ShortName'].str.lower().str.contains(fund_name.lower(), na=False) |
                        self.holdings_df['PortfolioName'].str.lower().str.contains(fund_name.lower(), na=False))
                filtered = self.holdings_df[mask]
                if len(filtered) > 0:
                    return filtered['MV_Base'].sum()
                return None
            
            def get_custodians(self):
                """Get list of all custodians"""
                holdings_custodians = set(self.holdings_df['CustodianName'].dropna().unique())
                trades_custodians = set(self.trades_df['CustodianName'].dropna().unique())
                return holdings_custodians | trades_custodians
            
            def get_counterparties(self):
                """Get list of all counterparties"""
                return self.trades_df['Counterparty'].dropna().unique().tolist()
            
            def get_security_types(self):
                """Get all security types in holdings"""
                return self.holdings_df['SecurityTypeName'].dropna().unique().tolist()
            
            def get_holdings_by_security_type(self, sec_type):
                """Get holdings count by security type"""
                mask = self.holdings_df['SecurityTypeName'].str.lower().str.contains(sec_type.lower(), na=False)
                return mask.sum()
            
            def get_pnl_mtd(self, fund_name=None):
                """Get MTD P&L"""
                if fund_name:
                    mask = (self.holdings_df['ShortName'].str.lower().str.contains(fund_name.lower(), na=False) |
                            self.holdings_df['PortfolioName'].str.lower().str.contains(fund_name.lower(), na=False))
                    filtered = self.holdings_df[mask]
                    if len(filtered) > 0:
                        return filtered['PL_MTD'].sum()
                    return None
                return self.holdings_df.groupby('ShortName')['PL_MTD'].sum().to_dict()
            
            def get_pnl_qtd(self, fund_name=None):
                """Get QTD P&L"""
                if fund_name:
                    mask = (self.holdings_df['ShortName'].str.lower().str.contains(fund_name.lower(), na=False) |
                            self.holdings_df['PortfolioName'].str.lower().str.contains(fund_name.lower(), na=False))
                    filtered = self.holdings_df[mask]
                    if len(filtered) > 0:
                        return filtered['PL_QTD'].sum()
                    return None
                return self.holdings_df.groupby('ShortName')['PL_QTD'].sum().to_dict()
            
            def get_total_quantity_for_fund(self, fund_name):
                """Get total quantity of holdings for a fund"""
                mask = (self.holdings_df['ShortName'].str.lower().str.contains(fund_name.lower(), na=False) |
                        self.holdings_df['PortfolioName'].str.lower().str.contains(fund_name.lower(), na=False))
                filtered = self.holdings_df[mask]
                if len(filtered) > 0:
                    return filtered['Qty'].sum()
                return None

            def extract_fund_name(self, question):
                """Extract fund name from question"""
                all_funds = self.get_all_funds()
                question_lower = question.lower()
                
                for fund in all_funds:
                    if fund.lower() in question_lower:
                        return fund
                
                # Try partial matching
                for fund in all_funds:
                    fund_words = fund.lower().split()
                    for word in fund_words:
                        if len(word) > 3 and word in question_lower:
                            return fund
                return None

            def process_question(self, question):
                """Process user question and return appropriate answer (formatted for HTML)"""
                question_lower = question.lower().strip()
                
                if not question_lower:
                    return "Please enter a question."
                
                # List all funds
                if any(phrase in question_lower for phrase in ['list all funds', 'all funds', 'what funds', 'which funds are there', 'show funds', 'available funds']):
                    funds = self.get_all_funds()
                    if funds:
                        return "<strong>Available funds/portfolios:</strong><br>" + "<br>".join(f"â€¢ {fund}" for fund in sorted(funds))
                    return "Sorry can not find the answer"
                
                # Total holdings
                if ('total' in question_lower and 'holdings' in question_lower) or ('how many' in question_lower and 'holdings' in question_lower):
                    fund_name = self.extract_fund_name(question)
                    if fund_name:
                        count = self.get_total_holdings_for_fund(fund_name)
                        if count:
                            return f"Total number of holdings for <strong>{fund_name}</strong>: {count}"
                        return f"Sorry can not find the answer for fund '{fund_name}'"
                    else:
                        return f"Total number of holdings across all funds: <strong>{self.get_total_holdings()}</strong>"
                
                # Total trades
                if ('total' in question_lower and 'trades' in question_lower) or ('how many' in question_lower and 'trades' in question_lower):
                    fund_name = self.extract_fund_name(question)
                    if fund_name:
                        count = self.get_total_trades_for_fund(fund_name)
                        if count:
                            return f"Total number of trades for <strong>{fund_name}</strong>: {count}"
                        return f"Sorry can not find the answer for fund '{fund_name}'"
                    else:
                        return f"Total number of trades across all funds: <strong>{self.get_total_trades()}</strong>"
                
                # Best performing
                if any(phrase in question_lower for phrase in ['best performing', 'top performing', 'highest profit', 'best fund', 'top fund', 'performed better', 'which fund performed']):
                    top_funds = self.get_best_performing_funds(10)
                    if len(top_funds) > 0:
                        result = "<strong>Best performing funds by YTD P&L:</strong><br>"
                        for i, (fund, pnl) in enumerate(top_funds.items(), 1):
                            result += f"{i}. {fund}: <strong>${pnl:,.2f}</strong><br>"
                        return result
                    return "Sorry can not find the answer"
                
                # Worst performing
                if any(phrase in question_lower for phrase in ['worst performing', 'lowest profit', 'worst fund', 'poor performing', 'lowest performing']):
                    worst_funds = self.get_worst_performing_funds(10)
                    if len(worst_funds) > 0:
                        result = "<strong>Worst performing funds by YTD P&L:</strong><br>"
                        for i, (fund, pnl) in enumerate(worst_funds.items(), 1):
                            result += f"{i}. {fund}: <strong>${pnl:,.2f}</strong><br>"
                        return result
                    return "Sorry can not find the answer"
                
                # P&L - YTD
                if any(phrase in question_lower for phrase in ['ytd', 'yearly', 'year to date', 'annual', 'profit and loss', 'pnl', 'p&l', 'profit', 'loss']):
                    fund_name = self.extract_fund_name(question)
                    if fund_name:
                        pnl = self.get_fund_pnl_ytd(fund_name)
                        if pnl is not None:
                            return f"YTD P&L for <strong>{fund_name}</strong>: <strong>${pnl:,.2f}</strong>"
                        return f"Sorry can not find the answer for fund '{fund_name}'"
                    else:
                        all_pnl = self.get_fund_pnl_ytd()
                        if all_pnl:
                            result = "<strong>YTD P&L for all funds:</strong><br>"
                            sorted_pnl = sorted(all_pnl.items(), key=lambda x: x[1], reverse=True)
                            for fund, pnl in sorted_pnl:
                                result += f"â€¢ {fund}: ${pnl:,.2f}<br>"
                            return result
                        return "Sorry can not find the answer"
                
                # Securities
                if any(phrase in question_lower for phrase in ['securities', 'what securities', 'which securities', 'holdings for']):
                    fund_name = self.extract_fund_name(question)
                    if fund_name:
                        securities = self.get_securities_for_fund(fund_name)
                        if securities:
                            return f"<strong>Securities held by {fund_name}:</strong><br>" + "<br>".join(f"â€¢ {sec}" for sec in securities)
                        return f"Sorry can not find the answer for fund '{fund_name}'"
                    return "Please specify a fund name."
                
                # Trade Types
                if any(phrase in question_lower for phrase in ['trade types', 'buy and sell', 'buys and sells', 'trade summary']):
                    summary = self.get_trade_types_summary()
                    if summary:
                        result = "<strong>Trade Types Summary:</strong><br>"
                        for trade_type, count in summary.items():
                            result += f"â€¢ {trade_type}: {count}<br>"
                        return result
                    return "Sorry can not find the answer"
                
                # Buy counts
                if 'buy' in question_lower and ('how many' in question_lower or 'number of' in question_lower or 'total' in question_lower):
                    count = self.get_trades_by_type('buy')
                    if count > 0:
                        return f"Total number of Buy trades: <strong>{count}</strong>"
                    return "Sorry can not find the answer"
                
                # Market Value
                if any(phrase in question_lower for phrase in ['market value', 'total value', 'mv', 'aum']):
                    fund_name = self.extract_fund_name(question)
                    if fund_name:
                        mv = self.get_fund_market_value(fund_name)
                        if mv is not None:
                            return f"Total market value for <strong>{fund_name}</strong>: ${mv:,.2f}"
                        return f"Sorry can not find the answer for fund '{fund_name}'"
                    else:
                        total_mv = self.holdings_df['MV_Base'].sum()
                        return f"Total market value across all funds: <strong>${total_mv:,.2f}</strong>"

                # Help
                if any(phrase in question_lower for phrase in ['help', 'what can you', 'commands']):
                    return "I can help you with questions about holdings and trades. Try asking about 'Total holdings', 'Best performing funds', or specific fund details!"

                return "Sorry can not find the answer"

        # -- End of DataChatbot Class --

        # Initialize Bot
        bot = DataChatbot()
        
        # Determine Ready State
        def signal_ready():
            document.getElementById("status-dot").classList.add("ready")
            document.getElementById("status-text").innerText = "Online & Ready"
            
            # Enable Inputs
            document.getElementById("user-input").disabled = False
            document.getElementById("user-input").placeholder = "Type your question here..."
            document.getElementById("send-btn").disabled = False
            
            # Bot Greeting
            add_bot_message("Data engine loaded! I'm ready to answer your questions.")

        # Helper to add message to DOM
        def add_bot_message(content):
            # We call the JS function defined in script block
            # This requires exposing JS function to window or simple direct DOM manipulation
            # Let's direct manipulate to match existing structure
            messages_div = document.getElementById("chat-messages")
            
            wrapper = document.createElement("div")
            wrapper.className = "message-wrapper bot"
            
            # Simple content structure
            # Note: Time handling simplified for PyScript context
            wrapper.innerHTML = f"""
                <div class="bot-avatar-small">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="message-content">
                    {content}
                </div>
            """
            messages_div.appendChild(wrapper)
            messages_div.scrollTop = messages_div.scrollHeight

        # Function called by JS Interaction
        def process_user_query(question):
            try:
                answer = bot.process_question(str(question))
                return answer
            except Exception as e:
                console.error(f"Error processing question: {e}")
                return "Sorry, I encountered an internal error."

        # Expose to JavaScript
        window.process_user_query = process_user_query
        
        # Signal Ready
        signal_ready()

    </py-script>

    <!-- JavaScript glue code -->
    <script>
        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        
        function formatTime(date) {
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function addMessage(content, isUser) {
            const wrapper = document.createElement('div');
            wrapper.className = `message-wrapper ${isUser ? 'user' : 'bot'}`;
            
            let avatarHtml = '';
            if (!isUser) {
                avatarHtml = `
                    <div class="bot-avatar-small">
                        <i class="fas fa-robot"></i>
                    </div>
                `;
            }
            
            // Format content if it's a user message (bot message comes pre-formatted from Python)
            let formattedContent = content;
            if (isUser) {
                 formattedContent = content.replace(/\\n/g, '<br>');
            }

            wrapper.innerHTML = `
                ${avatarHtml}
                <div>
                    <div class="message-content">${formattedContent}</div>
                    <div class="message-time">${formatTime(new Date())}</div>
                </div>
            `;
            
            chatMessages.appendChild(wrapper);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Bridge function called by UI
        async function triggerPython() {
            const question = userInput.value.trim();
            if (!question) return;

            // Add user message
            addMessage(question, true);
            userInput.value = '';

            // Show typing indicator
            showTyping();

            // Call Python (PyScript exposes functions on window)
            // We use setTimeout to allow UI to update (typing indicator) before Python blocks main thread
            setTimeout(() => {
                if (window.process_user_query) {
                    const answer = window.process_user_query(question);
                    hideTyping();
                    addMessage(answer, false);
                } else {
                    hideTyping();
                    addMessage("Error: Python engine not ready yet.", false);
                }
            }, 100);
        }

        function askQuestion(question) {
            userInput.value = question;
            triggerPython();
        }

        function showTyping() {
            const wrapper = document.createElement('div');
            wrapper.className = 'message-wrapper bot typing-message';
            wrapper.id = 'temp-typing';
            wrapper.innerHTML = `
                <div class="bot-avatar-small">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="message-content" style="padding: 12px 18px;">
                    <div class="typing-dots">
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>
                </div>
            `;
            chatMessages.appendChild(wrapper);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function hideTyping() {
            const typingMsg = document.getElementById('temp-typing');
            if (typingMsg) {
                typingMsg.remove();
            }
        }

        // Event Listeners
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                triggerPython();
            }
        });
    </script>
</body>
</html>
